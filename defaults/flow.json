[{"id":"9f12c2e3.6229","type":"websocket-listener","path":"/ws/ambulance/location","wholemsg":"false"},{"id":"9c54f8a2.eebac8","type":"http in","z":"8ed43b88.623078","name":"","url":"/operations3","method":"get","swaggerDoc":"","x":140,"y":162.5,"wires":[["fc612ebf.9277d"]]},{"id":"464137dc.a3dc38","type":"http response","z":"8ed43b88.623078","name":"","x":501.00001525878906,"y":162.50000762939453,"wires":[]},{"id":"fc612ebf.9277d","type":"template","z":"8ed43b88.623078","name":"OperationsView","field":"","template":"<!DOCTYPE html>\n<html>\n<head>\n  <title>Ambulance Dispatcher</title>\n  <script type=\"text/javascript\" src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js\"></script>\n  <script type=\"text/javascript\" src=\"https://maps.google.com/maps/api/js?sensor=true\"></script>\n  <script type=\"text/javascript\" src=\"https://rawgit.com/hpneo/gmaps/master/gmaps.js\"></script>\n  <link rel=\"stylesheet\" href=\"//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css\">\n  \n    <style type=\"text/css\" media=\"screen\">\n    #map {\n      position:absolute;\n      top: 0; bottom: 0; left: 0; right: 0;\n    }    \n    #panorama {\n    \twidth: 300px;\n    \theight: 300px;\n    \tz-index: 999;\n    }\n    #dispatch {  \n    \tfloat:right;\n    \twidth: 300px;\n    \theight: 18px;\n    \tz-index: 999;\n    \tposition:absolute;\n    }\n   \thtml, body, .row, #view, #map, #mapPartial, #infoPartial\n\t{\n    height: 100%;\n\t}\n\t#infoPartial {\n\t\tbackground:LightGrey;\n\t\tpadding-right:15px;\n\t}\n\t#requestSupervisor {\n\t\t\n    \twidth:95%;\n    \t\n\t}\n\t\n  </style>\n  \n</head>\n<body>\n\t    \n\t  \t<div class=\"row\" id=\"view\">\n\t  \t\t<div class=\"col-md-9 \" id=\"mapPartial\">\n\t\t\t  <div>\n\t\t\t  \t<div id=\"panorama\"><div id=\"dispatch\"><div><button id=\"dispatchBtn\">Enter Patient Information</button></div></div></div>\n\t\t\t  </div>\n\t\t\t  <div id=\"map\"></div> \n\t\t\t</div>\n\t\t\t<div class=\"col-md-3\" id=\"infoPartial\">\n\t\t\t\t<h2><span class=\"glyphicon glyphicon-earphone\"></span>113 Dispatcher</h2>\n\t\t\t\t<h5>Dispatcher ID: #10034</h5>\n\t\t\t\t<h5>Call ID: #134525</h5>\n\t\t\t\t<h5>Call Started: <script type=\"text/javascript\">document.write(new Date().toLocaleTimeString());</script></h5>\n\t\t\t\t<button id=\"requestSupervisor\" class=\"btn btn-danger\" type=\"submit\">Request Supervisor</button>\n\t\t\t\t<h3>Log</h3>\n\t\t\t\t<table id=\"log\" class=\"table table-striped\">\n\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>Time</th><th>Event</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th><script type=\"text/javascript\">document.write(new Date().toLocaleTimeString());</script></th><td> Incoming call</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\t\t\t\t\n\t\t\t</div>\n\t  \t</div>\n \n\n  <script type=\"text/javascript\">     \n  \tvar sv = new google.maps.StreetViewService();\n    // Address pointing to the WebSocket that patient GPS coordinates are retrieved from\n    var server = window.location.hostname;\n    //var patientLocation = \"ws://\"+server+\"/ws/patient/location\";\n    var ambulanceLocation = \"ws://\"+server+\"/ws/ambulance/location\";\n    var id;\n    var map;\n    var sock;\n    \n    $(document).ready(function(){\n    \n      // Create a new map centered on Hannover\n      map = new GMaps({\n        div: '#map',\n        lat: 59.9187606, \n        lng: 10.7120158,\n        zoom: 13\n      });\n      \n     map.setContextMenu({\n  \t\tcontrol: 'map',\n  \t\toptions: [{\n    \t\ttitle: 'Dispatch ambulance here',\n    \t\tname: 'dispatch',\n    \t\taction: function(e) {\n\t\t\t\tpanorama = GMaps.createPanorama({\n        \t\t\tel: '#panorama',\n        \t\t\tlat :  e.latLng.lat(),\n        \t\t\tlng:  e.latLng.lng(),\n        \t\t\tposition_changed: function(e) {\n        \t\t\t\tconsole.log('position_changed', panorama.getPosition());\n        \t\t\t} \n        \t\t});                   \n    \t\t}\n  \t\t}]\n\t});\n\t\n\t$.get('ambulanceLocation');\n      // Connect to Location websocket\n      //psock = new WebSocket(patientLocation);\n      asock = new WebSocket(ambulanceLocation);\n     console.log(\"test\");\n      asock.onopen = function(){ console.log(\"Connected websocket\");\n          console.log(\"Sender ping..\");\n          asock.send(\"Ping!\");\n          console.log(\"Ping sent..\");\n      };\n     \n      //psock.onerror = function(){ console.log(\"Websocket error\"); };\n      asock.onerror = function(){ console.log(\"Websocket error\"); };\n      \n      $('#dispatchBtn').bind('click', function() {\n        \t\t\t$.get('ambulanceLocation');\n      \t\t\t\tvar description = prompt(\"Incident description\", \"\");\n      \t\t\t\tvar patientName = prompt(\"Patient name\", \"\");\n      \t\t\t\tif(description) {\n      \t\t\t\t\tvar pos = panorama.getPosition();\n      \t\t\t\t\tvar panoId = panorama.getPano();\n      \t\t\t\t\tvar url = sv.getPanoramaById(panoId, function(data, status) {\n      \t\t\t\t\t\tconsole.log(\"panodata\", data.tiles);\n      \t\t\t\t\t\tvar url = \"https://maps.googleapis.com/maps/api/streetview?size=240x360&\"+\n      \t\t\t\t\t\t\"location=\"+pos.lat()+\",\"+pos.lng()+\"&fov=90&heading=\"+data.tiles.originHeading+\n      \t\t\t\t\t\t\"&pitch=\"+data.tiles.originPitch;\n      \t\t\t\t\t\tconsole.log(\"ID\", id);\n\t\t\t      \t\t\t$.post('dispatchAmbulance',{\n\t\t\t      \t\t\t\tid : id,\n\t\t\t      \t\t\t\tdescription: description,\n\t\t\t      \t\t\t\tpatientName: patientName,\n\t\t\t      \t\t\t\turl : url,\n\t\t\t      \t\t\t\tlat : pos.lat(),\n\t\t\t      \t\t\t\tlng : pos.lng()\n\t\t\t      \t\t\t}, function (){\n\t\t\t      \t\t\t            // add functionality to write to sidebar\n\t\t\t      \t\t\t            var time = new Date().toLocaleTimeString();\n\t\t\t      \t\t\t            var newRow = '<tr><th>' + time + '</th><td> Ambulance dispatched to ' + patientName + '</td></tr>';\n\t\t\t            \t\t\t\t\n\t\t\t            \t\t\t\t$(\"#log tbody\").append(newRow);\n\t\t\t            \t\t\t\t// window.alert(\"Ambulance has been dispatched\");\n\t\t\t            \t\t\t\tmap.addMarker({\n\t\t\t\t\t \t\t\t\t\t\tlat: pos.lat(),\n\t\t\t\t\t     \t\t\t\t\tlng: pos.lng(),\n\t\t\t\t\t      \t\t\t\t\ttitle: 'Incident',\n\t\t\t\t\t      \t\t\t\t\tinfoWindow: {\n\t \t\t\t\t\t\t\t\t\t\t\tcontent: description\n\t\t\t\t\t\t\t\t\t\t}});\n\t\n\t\t            \t\t});\n\t            \t\t});\n            \t\t}\n        \t\t});\n      \n      \n      var ambulanceMarker;      \n      // When GPS coordinates are received\n      asock.onmessage = function(evt){\n      \tvar data = JSON.parse(evt.data);\n      \tid = data.id;\n        console.log(data.payload.latitude);\n        console.log(data.payload.longitude);\n         \n        // Remove previous marker\n        map.removeMarker(ambulanceMarker);     \n        \n        console.log(\"Creating ambulance marker at \" + data.payload.latitude + \", \" + data.payload.longitude);\n        ambulanceMarker = map.addMarker({\n        \tlat: data.payload.latitude,\n        \tlng: data.payload.longitude,\n        \ticon : \"http://upload.wikimedia.org/wikipedia/commons/e/ed/Map_marker_icon_%E2%80%93_Nicolas_Mollet_%E2%80%93_Ambulance_%E2%80%93_Health_%26_Education_%E2%80%93_iOS.png\",\n            title: 'Latitude: ' + data.payload.latitude + '\\n' + 'Longitude: ' +  data.payload.longitude + '\\n' + 'Time: ' + data.payload.timestamp,\n            infoWindow: {\n \t\t\t\tcontent: '<b>'+data.name+'</b>'\n\t\t\t},\n\t\t\tclick: function(e) {\n\t\t\t\tpanorama = GMaps.createPanorama({\n        \t\t\tel: '#panorama',\n        \t\t\tlat : data.payload.latitude,\n        \t\t\tlng:  data.payload.longitude,\n        \t\t\tposition: \"TOP_RIGHT\",        \t\t\n        \t\t\tposition_changed: function(e) {\n        \t\t\t\tconsole.log('position_changed', panorama.getPosition());\n        \t\t\t} \n        \t\t});        \t\t\n\t\t\t}\n        });        \n      }\n    });\n  </script>\n</body>\n</html>","x":330.99998474121094,"y":162.5,"wires":[["464137dc.a3dc38"]]},{"id":"c68c4c64.720bc","type":"http request","z":"8ed43b88.623078","name":"Get ambulance location","method":"GET","url":"","x":829.0437698364258,"y":307.13489723205566,"wires":[["60b8ad04.1fec14","fd7b0de7.91356"]]},{"id":"69d023f9.ed949c","type":"websocket out","z":"8ed43b88.623078","name":"","server":"9f12c2e3.6229","client":"","x":1276.6427574157715,"y":443.6071252822876,"wires":[]},{"id":"f9d51042.2250c","type":"http in","z":"8ed43b88.623078","name":"","url":"/ambulanceLocation","method":"get","x":138,"y":290.5,"wires":[["9222d5c5.b29538","f7c0fcb6.07183"]]},{"id":"9222d5c5.b29538","type":"http response","z":"8ed43b88.623078","name":"","x":345.0000305175781,"y":288.5,"wires":[]},{"id":"777a4bce.9b02f4","type":"http in","z":"8ed43b88.623078","name":"","url":"/dispatchAmbulance","method":"post","x":165.0714569091797,"y":378.8214302062988,"wires":[["6e289f1.fa5396","e04e10a.2c390f"]]},{"id":"6e289f1.fa5396","type":"function","z":"8ed43b88.623078","name":"Store data","func":"msg.patientLat = msg.payload.lat;\nmsg.patientLng = msg.payload.lng;\nmsg.patientName = msg.payload.patientName;\nmsg.description = msg.payload.description;\nmsg.topic = msg.payload.id;\nmsg.patientName = msg.payload.patientName;\nmsg.streetViewUrl = msg.payload.url;\nmsg.url = context.global.url + \"/location/\"+msg.topic;\nreturn msg;","outputs":"1","x":275.8214569091797,"y":430.32143211364746,"wires":[["735bc018.fb2c7","b667fa93.097cf8"]]},{"id":"735bc018.fb2c7","type":"http request","z":"8ed43b88.623078","name":"Get ambulance location","method":"GET","url":"","x":387.57149505615234,"y":478.82143211364746,"wires":[["6523d8b9.fed148"]]},{"id":"6523d8b9.fed148","type":"json","z":"8ed43b88.623078","name":"","x":513.8214492797852,"y":512.0714321136475,"wires":[["f85a4c5b.16322","8170b167.7d632"]]},{"id":"f85a4c5b.16322","type":"function","z":"8ed43b88.623078","name":"Store ambulance location","func":"msg.ambuLat = msg.payload.latitude;\nmsg.ambuLng = msg.payload.longitude;\nmsg.headers = null; //This needs to be set to null. The Google maps API does not accept the headers\nreturn msg;","outputs":"1","x":646.0714530944824,"y":559.3214340209961,"wires":[["ec086e55.63c66","2848ba6d.6a9796"]]},{"id":"2848ba6d.6a9796","type":"http request","z":"8ed43b88.623078","name":"Get patient address","method":"GET","url":"https://maps.googleapis.com/maps/api/geocode/json?latlng={{patientLat}},{{patientLng}}&key=AIzaSyCGBvmim4kx0yem7iKdOghmtMk5XFD49uc","x":752.1826400756836,"y":626.0992660522461,"wires":[["ee851132.dad8c","1d1ac907.5564a7"]]},{"id":"1d1ac907.5564a7","type":"json","z":"8ed43b88.623078","name":"","x":885.8491821289062,"y":663.238151550293,"wires":[["fbd32452.623bd8"]]},{"id":"fbd32452.623bd8","type":"function","z":"8ed43b88.623078","name":"Construct Glass Notification","func":"var ambuLat = msg.ambuLat;\nvar ambuLng = msg.ambuLng;\nvar patientLat = msg.patientLat;\nvar patientLng = msg.patientLng;\nvar description = msg.description;\n\nvar kjernejournal;\nif(msg.patientName) {\n    var patient;\n\tpatient = context.global.patients[msg.patientName];\n\tkjernejournal = '<article><section><h1 class=\"text-large white\">Patient</h1><h2>' + patient.name + '</h2><h3 class=\"blue\">Critical medical data</h3></section><footer class=\"blue\">Swipe for more</footer></article>' +\n\t                '<article><section><table class=\"align-justify\"><tr><td class=\"text-large\">' + patient.name + '</td><td>' + patient.sex + '/' + patient.age + '/' + patient.bloodType +'</td></tr>'; \n\t                \n\tvar medicalHistory = \"\";\n\tpatient.medicalHistory.forEach(function (entry) {\n\t    medicalHistory += '<tr><td class=\"text-small\">' + entry + '</td><td></td></tr>';\n\t});\n\tkjernejournal += medicalHistory;\n\tkjernejournal += '</table></section><footer class=\"blue\">Medical history</footer></article>'\n\t\n\tkjernejournal += '<article><section><table class=\"align-justify\"><tr><td class=\"text-large\">' + patient.name + '</td><td>' + patient.sex + '/' + patient.age + '/' + patient.bloodType +'</td></tr>';\n\t\n\tvar prescriptions = \"\";\n\tpatient.prescriptions.forEach(function (entry) {\n\t    prescriptions += '<tr class=\"text-small\"><td>'+ entry +'</td><td></td></tr>';\n\t});\n\tkjernejournal += prescriptions;\n\tkjernejournal += '</table></section><footer class=\"blue\">Prescriptions</footer></article>';\n\t\n\tkjernejournal += '<article><section><table class=\"align-justify\"><tr><td class=\"text-large\">' + patient.name + '</td><td>' + patient.sex + '/' + patient.age + '/' + patient.bloodType +'</td></tr>';\n\tvar allergies = \"\";\n\tpatient.allergies.forEach(function (entry) {\n\t    allergies += '<tr class=\"text-small\"><td>'+ entry +'</td><td></td></tr>';\n\t});\n\tkjernejournal += allergies;\n\tkjernejournal += '</table></section><footer class=\"blue\">Allergies</footer></article>';\n}\n\n//var addr = \"glass://map?w=240&h=360&marker=1;\" + patientLat + \",\" + patientLng;\n//var addr = \"glass://map?w=240&h=360&marker=0;\" + ambuLat + \",\" + ambuLng + \"&marker=1;\" + patientLat + \",\" + patientLng;\nvar addr = msg.streetViewUrl;\n\n/*  Insert payload into Google Glass Timeline\n *  https://developers.google.com/glass/v1/reference/timeline/insert\n*/\n\nmsg.payload = {\n    \"notification\": {\n      \"level\": \"DEFAULT\"\n    },\n    \"callbackUrl\": \"https://mirrornotifications.appspot.com/forward?url=http://localhost:8081/reply\",\n    \"menuItems\": [{\n      \"action\": \"NAVIGATE\"\n    }],\n    \"html\": \"<article class=\\\"cover-only\\\"><figure><img src=\\\"\" + addr +  \"\\\" height=\\\"360\\\" width=\\\"240\\\"></figure><section><p style=\\\"padding-top:2px\\\" class=\\\"text-small\\\">Emergency response request:</p><div class=\\\"text-auto-size\\\"><p class=\\\"blue text-small\\\">\" + description + \"</p><p class=\\\"yellow text-small\\\">\"+msg.payload.results[0].formatted_address+\"</p></div></section><footer>Tap for details</footer></article>\"+kjernejournal,\n    //\"html\": \"<article class=\\\"cover-only\\\"><figure><img src=\\\"\" + addr +  \"\\\" height=\\\"360\\\" width=\\\"240\\\"></figure><section><p class=\\\"text-small\\\">Utrykningsforesp?rsel:</p><div class=\\\"text-auto-size\\\"><p class=\\\"blue text-small\\\">\" + description + \"</p><p class=\\\"yellow text-small\\\">\"+msg.payload.results[0].formatted_address+\"</p></div></section><footer>Tap for more</footer></article>\"+kjernejournal,\n    \"location\": {\n      \"latitude\": msg.payload.results[0].latitude,\n      \"longitude\": msg.payload.results[0].longitude,\n      \"displayName\": msg.payload.results[0].formatted_address\n    }\n};\nmsg.url = context.global.url + \"/timeline/\"+ msg.topic;\nreturn msg; ","outputs":"1","noerr":0,"x":1104.5714721679688,"y":666.0714645385742,"wires":[["5cc15f29.7fdfe","e4f98e9.a0e1f7"]]},{"id":"5cc15f29.7fdfe","type":"http request","z":"8ed43b88.623078","name":"Send notification to ambulance","method":"POST","url":"","x":1230.5714721679688,"y":791.3214645385742,"wires":[["8900958e.da3c88","89a5471e.0fe408"]]},{"id":"b6087f82.8dbeb","type":"http response","z":"8ed43b88.623078","name":"Send response to OperationsView ","x":1468.3214721679688,"y":860.0714645385742,"wires":[]},{"id":"ee851132.dad8c","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"patientLat","x":1050.7659339904785,"y":612.2658958435059,"wires":[]},{"id":"e04e10a.2c390f","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"payload","x":372.07146072387695,"y":378.8214302062988,"wires":[]},{"id":"8170b167.7d632","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"false","x":665.07151222229,"y":511.8214330673218,"wires":[]},{"id":"ec086e55.63c66","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"payload","x":863.8214569091797,"y":559.5714321136475,"wires":[]},{"id":"d9756c13.45212","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"false","x":1294.9285736083984,"y":397.2500009536743,"wires":[]},{"id":"f7c0fcb6.07183","type":"http request","z":"8ed43b88.623078","name":"Get available Glasses","method":"GET","url":"http://{{req.headers.host}}/getAuthorized","x":348,"y":201.5,"wires":[["488ac9d6.a43648"]]},{"id":"a062bcc.9e5e34","type":"inject","z":"8ed43b88.623078","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":207.5,"wires":[["f7c0fcb6.07183"]]},{"id":"6d837fe7.8d865","type":"function","z":"8ed43b88.623078","name":"Create one msg per Glass","func":"\ncontext.global.glasses = msg.payload;\nvar messages = [];\nfor(var id in msg.payload) {\t\n\tmessages.push({topic: id, name: msg.payload[id].name});\n}\nreturn [messages];","outputs":1,"x":630.0000228881836,"y":253.2142848968506,"wires":[["d0fd737c.c4721"]]},{"id":"488ac9d6.a43648","type":"json","z":"8ed43b88.623078","name":"","x":516.0000152587891,"y":207.5,"wires":[["6d837fe7.8d865"]]},{"id":"d38ebb6a.3c7298","type":"function","z":"8ed43b88.623078","name":"Add Glass ID and name to payload","func":"msg.payload = {id: msg.topic, name: msg.name, payload: msg.payload};\nreturn msg;","outputs":1,"x":1071.4285697937012,"y":397.25,"wires":[["69d023f9.ed949c","d9756c13.45212"]]},{"id":"60b8ad04.1fec14","type":"json","z":"8ed43b88.623078","name":"","x":923.4285697937012,"y":352.75,"wires":[["d38ebb6a.3c7298"]]},{"id":"8e67035d.cee73","type":"inject","z":"8ed43b88.623078","name":"On startup","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":140.00003051757812,"y":330.5,"wires":[["aef8a919.739f48"]]},{"id":"aef8a919.739f48","type":"function","z":"8ed43b88.623078","name":"Register patients","func":"var patientsJson = {};\npatientsJson['John Doe'] = {\n    \"name\": \"John Doe\",\n    \"age\": \"39\",\n    \"sex\": \"M\",\n    \"organDonor\": true,\n    \"bloodType\": \"A+\",\n    \"medicalHistory\": [\"Diabetic\", \"Spinal Disc Herniation\"],\n    \"prescriptions\": [\"Insulin\"],\n    \"allergies\": [\"Penicilin\", \"Seafood\"]\n};\npatientsJson['Jane Fisher'] = {\n    \"name\": \"Jane Fisher\",\n    \"age\": \"33\",\n    \"sex\": \"F\",\n    \"organDonor\": false,\n    \"bloodType\": \"0-\",\n    \"medicalHistory\": [\"Anaphylactic reaction\", \"Mild depression\"],\n    \"prescriptions\": [\"Trimethoprim\"],\n    \"allergies\": [\"Insect stings\", \"Sun sensitivity\"]\n};\npatientsJson['Helen Driscoll'] = {\n    \"name\": \"Helen Driscoll\",\n    \"age\": \"21\",\n    \"sex\": \"F\",\n    \"organDonor\": true,\n    \"bloodType\": \"B+\",\n    \"medicalHistory\": [\"Anxiety\"],\n    \"prescriptions\": [\"Cerazette\", \"Cetrizine\", \"Diazepam\"],\n    \"allergies\": [\"Pollen\", \"Egg\"]\n};\n\ncontext.global.patients = patientsJson;\n\n","outputs":1,"noerr":0,"x":312.0000305175781,"y":330.5,"wires":[[]]},{"id":"d678b98c.c2c408","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"true","x":956.7142944335938,"y":202.7857208251953,"wires":[]},{"id":"b667fa93.097cf8","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"true","x":531.75,"y":430.75,"wires":[]},{"id":"fd7b0de7.91356","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"res.headers","x":1099.4444046020508,"y":263.5,"wires":[]},{"id":"d0fd737c.c4721","type":"function","z":"8ed43b88.623078","name":"Set msg.url","func":"msg.url = context.global.url + \"/location/\"+ msg.topic;\nreturn msg;","outputs":1,"x":605.5555555555557,"y":316.5,"wires":[["d678b98c.c2c408","c68c4c64.720bc"]]},{"id":"c3d7b7b8.656d08","type":"inject","z":"8ed43b88.623078","name":"","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":true,"x":130.77777481079102,"y":61.722195625305176,"wires":[["b3971558.b3b288"]]},{"id":"b3971558.b3b288","type":"function","z":"8ed43b88.623078","name":"context variables","func":"context.global.url = \"https://helsinki.mybluemix.net\";\ncontext.global.CLIENT_ID = \"476168557117-9c9fqlj61fs3h34kkut7s5qq55avaem0.apps.googleusercontent.com\";\ncontext.global.CLIENT_SECRET = \"MoZiGZESrCjkJWHpufs7Mb9u\";\nreturn msg;","outputs":1,"noerr":0,"x":330.8333282470703,"y":57.72220325469971,"wires":[[]]},{"id":"e4f98e9.a0e1f7","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"payload.html","x":1299,"y":701.7221956253052,"wires":[]},{"id":"8900958e.da3c88","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"false","x":1481,"y":757.7221956253052,"wires":[]},{"id":"f39ec17b.009c","type":"http in","z":"8ed43b88.623078","name":"","url":"/operations","method":"get","swaggerDoc":"","x":117,"y":113.72219562530518,"wires":[["c278cee7.4a9ba"]]},{"id":"c278cee7.4a9ba","type":"template","z":"8ed43b88.623078","name":"OperationsView2","field":"","fieldType":"msg","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n\n<head>\n\t<title>Ambulance Dispatcher</title>\n\t<script type=\"text/javascript\" src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js\"></script>\n\t<script type=\"text/javascript\" src=\"//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js\"></script>\n\t<link rel=\"stylesheet\" href=\"//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css\">\n\n\t<style type=\"text/css\" media=\"screen\">\n\t\t#map {\n\t\t\tposition: absolute;\n\t\t\ttop: 0;\n\t\t\tbottom: 0;\n\t\t\tleft: 0;\n\t\t\tright: 0;\n\t\t}\n\t\t\n\t\t#panorama {\n\t\t\twidth: 100%;\n\t\t\theight: 300px;\n\t\t\tz-index: 999;\n\t\t}\n\t\t\n\t\t#dispatch {\n\t\t\tfloat: right;\n\t\t\twidth: 300px;\n\t\t\theight: 18px;\n\t\t\tz-index: 999;\n\t\t\tposition: absolute;\n\t\t}\n\t\t\n\t\thtml,\n\t\tbody,\n\t\t.row,\n\t\t#view,\n\t\t#map,\n\t\t#mapPartial,\n\t\t#infoPartial {\n\t\t\theight: 100%;\n\t\t}\n\t\t\n\t\t#infoPartial {\n\t\t\tbackground: LightGrey;\n\t\t\tpadding-right: 15px;\n\t\t}\n\t\t\n\t\t.modal-footer {\n\t\t\ttext-align: center;\n\t\t}\n\t\t\n\t\t#dispatchBtn {\n\t\t\twidth: 95%;\n\t\t}\n\t\t\n\t\t#endCallBtn {\n\t\t\twidth: 95%;\n\t\t}\n\t\t\n\t\t#patientInfoBtn {\n\t\t\twidth: 95%;\n\t\t\tmargin: 0 auto;\n\t\t}\n\t\t\n\t\t#buttonCenter {\n\t\t\ttext-align: center;\n\t\t}\n\t\t\n\t\t#availableAmbulances {\n\t\t\tposition: relative;\n\t\t\theight: 180px;\n\t\t\tclear:both;\n\t\t\tpadding-top:20px;\n\t\t}\n\t\t\n\t\t#patientSearchInfoResult {\n\t\t\ttext-align: center;\n\t\t}\n\t\t\n\t\t.controls {\n\t\t\tmargin-top: 10px;\n\t\t\tborder: 1px solid transparent;\n\t\t\tborder-radius: 2px 0 0 2px;\n\t\t\tbox-sizing: border-box;\n\t\t\t-moz-box-sizing: border-box;\n\t\t\theight: 32px;\n\t\t\toutline: none;\n\t\t\tbox-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);\n\t\t}\n\t\t\n\t\t#pac-input {\n\t\t\tbackground-color: #fff;\n\t\t\tfont-family: Roboto;\n\t\t\tfont-size: 15px;\n\t\t\tfont-weight: 300;\n\t\t\tmargin-left: 30px;\n\t\t\tpadding: 0 11px 0 13px;\n\t\t\ttext-overflow: ellipsis;\n\t\t\twidth: 300px;\n\t\t}\n\t\t\n\t\t#pac-input:focus {\n\t\t\tborder-color: #4d90fe;\n\t\t}\n\t\t\n\t\t.pac-container {\n\t\t\tfont-family: Roboto;\n\t\t}\n\t</style>\n\n</head>\n\n<body>\n\n\t\n\t<div id=\"dispatchModal\" class=\"modal fade\" role=\"dialog\">\n\t\t<div class=\"modal-dialog\">\n\n\t\t\t<!-- Modal content-->\n\t\t\t<div class=\"modal-content\">\n\t\t\t\t<div class=\"modal-header\">\n\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\n\t\t\t\t\t<h4 class=\"modal-title\">Dispatch ambulance to this location</h4>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"modal-body\">\n\t\t\t\t\t<div id=\"panorama\">\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"modal-footer\">\n\t\t\t\t\t<button id=\"dispatchBtn\" class=\"btn btn-success\" type=\"submit\">Dispatch Ambulance</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t</div>\n\t</div>\n\n\t<div id=\"patientModal\" class=\"modal fade\" role=\"dialog\">\n\t\t<div class=\"modal-dialog\">\n\n\t\t\t<!-- Modal content-->\n\t\t\t<div class=\"modal-content\">\n\t\t\t\t<div class=\"modal-header\">\n\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\n\t\t\t\t\t<h4 class=\"modal-title\">Send patient information to ambulance</h4>\n\t\t\t\t</div>\n\t\t\t\t<form id=\"patientInfo\">\n\t\t\t\t\t<div class=\"modal-body\">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t<label for=\"patientName\">Patient name</label>\n\t\t\t\t\t\t\t\t<div class=\"input-group\">\n\t\t\t\t\t\t\t\t\t<input type=\"text\" class=\"form-control\" id=\"patientName\" placeholder=\"Search for patient ...\">\n\t\t\t\t\t\t\t\t\t<span class=\"input-group-btn\">\n\t\t\t\t\t\t\t\t        <button id=\"patientSearchBtn\" class=\"btn btn-default\" type=\"button\"><span class=\"glyphicon glyphicon-search\"></span></button>\n\t\t\t\t\t\t\t\t    </span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div id=\"patientSearchInfoResult\">\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t<label for=\"description\">Short description of incident</label>\n\t\t\t\t\t\t\t\t<input type=\"text\" class=\"form-control\" id=\"description\" placeholder=\"Short description of incident\">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"modal-footer\">\n\t\t\t\t\t\t<button id=\"patientInfoBtn\" class=\"btn btn-primary\" type=\"submit\">Send patient information</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div class=\"row\" id=\"view\">\n\t\t<div class=\"col-md-9 \" id=\"mapPartial\">\n\t\t\t<div>\n\t\t\t\t<div id=\"panorama\">\n\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<input id=\"pac-input\" class=\"controls\" type=\"text\" placeholder=\"Search Box\">\n\t\t\t<div id=\"map\"></div>\n\t\t</div>\n\t\t<div class=\"col-md-3\" id=\"infoPartial\">\n\t\t\t<h2><span class=\"glyphicon glyphicon-earphone\"></span>911 Dispatcher</h2>\n\t\t\t<h5>Dispatcher ID: #10034</h5>\n\t\t\t<h5>Call ID: #134525</h5>\n\t\t\t<h5>Call Started: <script type=\"text/javascript\">document.write(new Date().toLocaleTimeString());</script></h5>\n\t\t\t<button id=\"endCallBtn\" class=\"btn btn-danger\" type=\"submit\">End call</button>\n\t\t\t<h3>Log</h3>\n\t\t\t<div>\n\t\t\t\t<table id=\"log\" class=\"table table-striped\">\n\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>Time</th>\n\t\t\t\t\t\t\t<th>Event</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>\n\t\t\t\t\t\t\t\t<script type=\"text/javascript\">\n\t\t\t\t\t\t\t\t\tdocument.write(new Date().toLocaleTimeString());\n\t\t\t\t\t\t\t\t</script>\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<td> Incoming call</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t\t<!--<div>\n\t\t\t\t<h3>Available ambulances:</h3>\n\t\t\t\t<ul id=\"availableAmbulances\">\n\t\t\t\t\t\n\t\t\t\t</ul>\n\t\t\t</div>-->\n\t\t</div>\n\t</div>\n\t\n\n\t<script type=\"text/javascript\">\n\t\tvar panorama;\n\t\t\n\t\t$('#endCallBtn').click(function() {\n\t\t\tlocation.reload();\n\t\t});\n\t\t\n\t\tfunction initMap() {\n\t\t\tvar location = {\n\t\t\t\tlat: 60.1637088,\n\t\t\t\tlng: 24.7600956\n\t\t\t};\n\t\t\tvar map = new google.maps.Map(document.getElementById('map'), {\n\t\t\t\tzoom: 12,\n\t\t\t\tcenter: location,\n\t\t\t\tmapTypeId: google.maps.MapTypeId.ROADMAP,\n\t\t\t\tmapTypeControl: false,\n\t\t\t\tstreetViewControl: false\n\t\t\t});\n\n\t\t\t//updateAvailableAmbulances();\n\t\t\tinitRightClick(map);\n\t\t\tinitSearchBox(map);\n\t\t}\n\n\t\tfunction initRightClick(map) {\n\t\t\tvar icon = {\n\t\t\t\turl: 'https://maps.gstatic.com/mapfiles/place_api/icons/geocode-71.png',\n\t\t\t\tsize: new google.maps.Size(71, 71),\n\t\t\t\torigin: new google.maps.Point(0, 0),\n\t\t\t\tanchor: new google.maps.Point(17, 34),\n\t\t\t\tscaledSize: new google.maps.Size(25, 25)\n\t\t\t};\n\n\t\t\tvar marker = new google.maps.Marker({\n\t\t\t\ticon: icon,\n\t\t\t\ttitle: 'location'\n\t\t\t});\n\n\t\t\tmarker.addListener('click', function() {\n\t\t\t\tshowStreetviewModal(marker);\n\t\t\t});\n\n\t\t\tgoogle.maps.event.addDomListener(map, 'rightclick', function(e) {\n\t\t\t\tmarker.setPosition(e.latLng);\n\t\t\t\tmarker.setMap(map);\n\t\t\t});\n\t\t}\n\n\t\tfunction initSearchBox(map) {\n\t\t\tvar input = document.getElementById('pac-input');\n\t\t\tvar searchBox = new google.maps.places.SearchBox(input);\n\t\t\tmap.controls[google.maps.ControlPosition.TOP_LEFT].push(input);\n\n\t\t\t// Bias the SearchBox results towards current map's viewport.\n\t\t\tmap.addListener('bounds_changed', function() {\n\t\t\t\tsearchBox.setBounds(map.getBounds());\n\t\t\t});\n\n\t\t\tvar markers = [];\n\t\t\t// [START region_getplaces]\n\t\t\t// Listen for the event fired when the user selects a prediction and retrieve\n\t\t\t// more details for that place.\n\t\t\tsearchBox.addListener('places_changed', function() {\n\t\t\t\tvar places = searchBox.getPlaces();\n\n\t\t\t\tif (places.length == 0) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Clear out the old markers.\n\t\t\t\tmarkers.forEach(function(marker) {\n\t\t\t\t\tmarker.setMap(null);\n\t\t\t\t});\n\t\t\t\tmarkers = [];\n\n\t\t\t\t// For each place, get the icon, name and location.\n\t\t\t\tvar bounds = new google.maps.LatLngBounds();\n\t\t\t\tplaces.forEach(function(place) {\n\t\t\t\t\tvar icon = {\n\t\t\t\t\t\turl: 'https://maps.gstatic.com/mapfiles/place_api/icons/geocode-71.png',\n\t\t\t\t\t\tsize: new google.maps.Size(71, 71),\n\t\t\t\t\t\torigin: new google.maps.Point(0, 0),\n\t\t\t\t\t\tanchor: new google.maps.Point(17, 34),\n\t\t\t\t\t\tscaledSize: new google.maps.Size(25, 25)\n\t\t\t\t\t};\n\n\t\t\t\t\tvar marker = new google.maps.Marker({\n\t\t\t\t\t\tmap: map,\n\t\t\t\t\t\ticon: icon,\n\t\t\t\t\t\ttitle: place.name,\n\t\t\t\t\t\tposition: place.geometry.location\n\t\t\t\t\t});\n\n\t\t\t\t\t// Create a marker for each place.\n\t\t\t\t\tmarkers.push(marker);\n\n\t\t\t\t\tmarker.addListener('click', function() {\n\t\t\t\t\t\tshowStreetviewModal(marker);\n\t\t\t\t\t});\n\n\t\t\t\t\tif (place.geometry.viewport) {\n\t\t\t\t\t\t// Only geocodes have viewport.\n\t\t\t\t\t\tbounds.union(place.geometry.viewport);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tbounds.extend(place.geometry.location);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tmap.panToBounds(bounds);\n\t\t\t});\n\t\t}\n\n\t\tfunction showStreetviewModal(marker) {\n\t\t\tpanorama = new google.maps.StreetViewPanorama(\n\t\t\t\tdocument.getElementById('panorama'), {\n\t\t\t\t\tposition: marker.getPosition(),\n\t\t\t\t\tpov: {\n\t\t\t\t\t\theading: 165,\n\t\t\t\t\t\tpitch: 0\n\t\t\t\t\t},\n\t\t\t\t\tzoom: 1,\n\t\t\t\t\tdisableDefaultUI: true\n\t\t\t\t});\n\t\t\t$('#dispatchModal').modal('show');\n\t\t\t$('#dispatchModal').on('shown.bs.modal', function() {\n\t\t\t\tgoogle.maps.event.trigger(panorama, \"resize\");\n\t\t\t});\n\n\t\t\t$('#dispatchBtn').bind('click', function() {\n\t\t\t\tvar url = \"https://maps.googleapis.com/maps/api/streetview?size=240x360&\" +\n\t\t\t\t\t\"location=\" + marker.getPosition().lat() + \",\" + marker.getPosition().lng() + \"&fov=90&heading=\" + panorama.getPov().heading +\n\t\t\t\t\t\"&pitch=\" + panorama.getPov().pitch;\n\t\t\t\t$.post('/dispatchAmbulance2', {\n\t\t\t\t\tid: '102159532536147848905',\n\t\t\t\t\tlat: marker.getPosition().lat(),\n\t\t\t\t\tlng: marker.getPosition().lng(),\n\t\t\t\t\turl: url\n\t\t\t\t}, function() {\n\t\t\t\t\t// add functionality to write to sidebar\n\t\t\t\t\tvar time = new Date().toLocaleTimeString();\n\t\t\t\t\tvar newRow = '<tr><th>' + time + '</th><td> Ambulance dispatched' + '</td></tr>';\n\n\t\t\t\t\t$(\"#log tbody\").append(newRow);\n\t\t\t\t\t$('#dispatchModal').modal('hide');\n\n\t\t\t\t\tvar icon = {\n\t\t\t\t\t\turl: 'http://auto-accident-denver.com/wp-content/uploads/2015/12/emergency-Icon.jpeg-25.png',\n\t\t\t\t\t};\n\n\t\t\t\t\tambulanceMarker = new google.maps.Marker({\n\t\t\t\t\t    icon: icon,\n\t\t\t\t\t\tmap: marker.getMap(),\n\t\t\t\t\t\ttitle: 'Incident',\n\t\t\t\t\t\tposition: marker.getPosition()\n\t\t\t\t\t});\n\n\t\t\t\t\tambulanceMarker.addListener('click', function() {\n\t\t\t\t\t\tshowPatientInformationModal(marker);\n\t\t\t\t\t});\n\n\t\t\t\t\tmarker.setMap(null);\n\t\t\t\t})\n\t\t\t});\n\n\t\t}\n\n\t\tfunction showPatientInformationModal(marker) {\n\t\t\t$('#patientInfoBtn').attr(\"disabled\", true);\n\t\t\t$('#patientModal').modal('show');\n\t\t\t\n\t\t\t$('#patientSearchBtn').click(function(){\n\t\t\t\t$.get('https://ambulance-iot-demo.mybluemix.net/patientData', {\n\t\t\t\t\tpatientName: $('input[id=patientName]').val()\n\t\t\t\t}, function(data) {\n\t\t\t\t\tvar patientData = '<h3>' + data.name + ' <small>' + data.sex + '/' + data.age + '</small></h3>';\n\t\t\t\t\t$(\"#patientSearchInfoResult\").html(patientData);\n\t\t\t\t\t$('#patientInfoBtn').attr(\"disabled\", false);\n\t\t\t\t}).fail(function() {\n\t\t\t\t\t$(\"#patientSearchInfoResult\").html('');\n\t\t\t\t\t$('#patientInfoBtn').attr(\"disabled\", true);\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t\t$('form').submit(function(event) {\n\t\t\t\tvar patientName = $('input[id=patientName]').val();\n\t\t\t\tvar description = $('input[id=description]').val()\n\t\t\t\t$.post('https://ambulance-iot-demo.mybluemix.net/patientInfo', {\n\t\t\t\t\tid: '102159532536147848905',\n\t\t\t\t\tpatientName: patientName,\n\t\t\t\t\tdescription: description\n\t\t\t\t}, function() {\n\t\t\t\t\t$('#patientModal').modal('hide');\n\t\t\t\t\tvar time = new Date().toLocaleTimeString();\n\t\t\t\t\tvar newRow = '<tr><th>' + time + '</th><td> Patient information sent for ' + patientName + '</td></tr>';\n\n\t\t\t\t\t$(\"#log tbody\").append(newRow);\n\t\t\t\t});\n\t\t\t\tevent.preventDefault();\n\t\t\t});\n\t\t}\n\t\t\n\t\tfunction updateAvailableAmbulances() {\n\t\t\t$.get('https://ambulance-iot-demo.mybluemix.net/getAuthorized', function(data) {\n\t\t\t\tObject.keys(data).forEach(function(key) {\n\t\t\t\t\tvar row = '<li>' + data[key].name + '</li>';\n\t\t\t\t\t$(\"#availableAmbulances\").append(row);\n\t\t\t\t});\n\t\t\t});\t\n\t\t}\n\t</script>\n\t<script async defer src=\"https://maps.googleapis.com/maps/api/js?libraries=places&callback=initMap\"></script>\n</body>\n\n</html>","x":312,"y":111.72219562530518,"wires":[["90c25950.f1c558"]]},{"id":"90c25950.f1c558","type":"http response","z":"8ed43b88.623078","name":"","x":468,"y":112.72219562530518,"wires":[]},{"id":"3cfe5611.25098a","type":"http in","z":"8ed43b88.623078","name":"","url":"/dispatchAmbulance2","method":"post","swaggerDoc":"","x":143,"y":684.7221956253052,"wires":[["10c373f1.d6eb6c","e7b8da0c.42c428"]]},{"id":"10c373f1.d6eb6c","type":"function","z":"8ed43b88.623078","name":"Store data","func":"msg.patientLat = msg.payload.lat;\nmsg.patientLng = msg.payload.lng;\nmsg.topic = msg.payload.id;\nmsg.streetViewUrl = msg.payload.url;\nmsg.url = context.global.url + \"/location/\"+msg.topic;\nreturn msg;","outputs":1,"noerr":0,"x":406,"y":681.7221956253052,"wires":[["d029b124.b3a0e"]]},{"id":"d029b124.b3a0e","type":"http request","z":"8ed43b88.623078","name":"Get patient address","method":"GET","url":"https://maps.googleapis.com/maps/api/geocode/json?latlng={{patientLat}},{{patientLng}}&key=AIzaSyCGBvmim4kx0yem7iKdOghmtMk5XFD49uc","x":583,"y":713.7221956253052,"wires":[["9b065742.07dec8"]]},{"id":"a8b660c4.43119","type":"function","z":"8ed43b88.623078","name":"","func":"var addr = msg.streetViewUrl;\n\n/*  Insert payload into Google Glass Timeline\n *  https://developers.google.com/glass/v1/reference/timeline/insert\n*/\n\nmsg.payload = {\n    \"notification\": {\n      \"level\": \"DEFAULT\"\n    },\n    \"callbackUrl\": \"https://mirrornotifications.appspot.com/forward?url=http://localhost:8081/reply\",\n    \"menuItems\": [{\n      \"action\": \"NAVIGATE\"\n    }],\n    \"html\": \"<article class=\\\"cover-only\\\"><figure><img src=\\\"\" + addr +  \"\\\" height=\\\"360\\\" width=\\\"240\\\"></figure><section><p style=\\\"padding-top:2px\\\" class=\\\"text-small\\\">Emergency response request:</p><div class=\\\"text-auto-size\\\"><p class=\\\"yellow text-small\\\">\"+msg.payload.results[0].formatted_address+\"</p></div></section><footer>Tap for GPS</footer></article>\",\n    \"location\": {\n      \"latitude\": msg.payload.results[0].latitude,\n      \"longitude\": msg.payload.results[0].longitude,\n      \"displayName\": msg.payload.results[0].formatted_address\n    }\n};\nmsg.url = context.global.url + \"/timeline/\"+ msg.topic;\nreturn msg; ","outputs":1,"noerr":0,"x":927,"y":788.7222213745117,"wires":[["5cc15f29.7fdfe","22b53267.f929de"]]},{"id":"22b53267.f929de","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"false","complete":"false","x":1006.9999389648438,"y":876.7222213745117,"wires":[]},{"id":"9b065742.07dec8","type":"json","z":"8ed43b88.623078","name":"","x":785,"y":727.7221956253052,"wires":[["a8b660c4.43119"]]},{"id":"89a5471e.0fe408","type":"function","z":"8ed43b88.623078","name":"","func":"msg.headers = {\n    \"Access-Control-Allow-Origin\": \"*\"\n};\nreturn msg;","outputs":1,"noerr":0,"x":1238,"y":871.7221956253052,"wires":[["b6087f82.8dbeb"]]},{"id":"4e4d9162.2a264","type":"http in","z":"8ed43b88.623078","name":"","url":"/patientInfo","method":"post","swaggerDoc":"","x":148,"y":794.7221956253052,"wires":[["35ffd428.e62adc"]]},{"id":"35ffd428.e62adc","type":"function","z":"8ed43b88.623078","name":"Store data","func":"msg.patientName = msg.payload.patientName;\nmsg.description = msg.payload.description;\nmsg.topic = msg.payload.id;\nmsg.url = context.global.url + \"/location/\"+msg.topic;\n\nreturn msg;","outputs":1,"noerr":0,"x":329,"y":803.7221956253052,"wires":[["99e6d6d5.a4a0f8","89630462.1fa058"]]},{"id":"99e6d6d5.a4a0f8","type":"function","z":"8ed43b88.623078","name":"Construct Glass Notification","func":"var description = msg.description;\n\nvar kjernejournal;\nif(msg.patientName) {\n    var patient;\n\tpatient = context.global.patients[msg.patientName];\n\tkjernejournal = '<article><section><h1 class=\"text-large white\">Patient</h1><h2>' + patient.name + '</h2><h3 class=\"blue\">Critical medical data</h3></section><footer class=\"blue\">Swipe for more</footer></article>' +\n\t                '<article><section><table class=\"align-justify\"><tr><td class=\"text-large\">' + patient.name + '</td><td>' + patient.sex + '/' + patient.age + '/' + patient.bloodType +'</td></tr>'; \n\t                \n\tvar medicalHistory = \"\";\n\tpatient.medicalHistory.forEach(function (entry) {\n\t    medicalHistory += '<tr><td class=\"text-small\">' + entry + '</td><td></td></tr>';\n\t});\n\tkjernejournal += medicalHistory;\n\tkjernejournal += '</table></section><footer class=\"blue\">Medical history</footer></article>'\n\t\n\tkjernejournal += '<article><section><table class=\"align-justify\"><tr><td class=\"text-large\">' + patient.name + '</td><td>' + patient.sex + '/' + patient.age + '/' + patient.bloodType +'</td></tr>';\n\t\n\tvar prescriptions = \"\";\n\tpatient.prescriptions.forEach(function (entry) {\n\t    prescriptions += '<tr class=\"text-small\"><td>'+ entry +'</td><td></td></tr>';\n\t});\n\tkjernejournal += prescriptions;\n\tkjernejournal += '</table></section><footer class=\"blue\">Prescriptions</footer></article>';\n\t\n\tkjernejournal += '<article><section><table class=\"align-justify\"><tr><td class=\"text-large\">' + patient.name + '</td><td>' + patient.sex + '/' + patient.age + '/' + patient.bloodType +'</td></tr>';\n\tvar allergies = \"\";\n\tpatient.allergies.forEach(function (entry) {\n\t    allergies += '<tr class=\"text-small\"><td>'+ entry +'</td><td></td></tr>';\n\t});\n\tkjernejournal += allergies;\n\tkjernejournal += '</table></section><footer class=\"blue\">Allergies</footer></article>';\n}\n\nmsg.payload = {\n    \"notification\": {\n      \"level\": \"DEFAULT\"\n    },\n    \"callbackUrl\": \"https://mirrornotifications.appspot.com/forward?url=http://localhost:8081/reply\",\n\n    //\"html\": \"<article class=\\\"cover-only\\\"><figure><img src=\\\"\" + addr +  \"\\\" height=\\\"360\\\" width=\\\"240\\\"></figure><section><p style=\\\"padding-top:2px\\\" class=\\\"text-small\\\">Emergency response request:</p><div class=\\\"text-auto-size\\\"><p class=\\\"blue text-small\\\">\" + description + \"</p><p class=\\\"yellow text-small\\\">\"+msg.payload.results[0].formatted_address+\"</p></div></section><footer>Tap for details</footer></article>\"+kjernejournal,\n    \"html\": kjernejournal\n};\nmsg.url = context.global.url + \"/timeline/\"+ msg.topic;\nreturn msg; ","outputs":"1","noerr":0,"x":567,"y":856.7221956253052,"wires":[["5cc15f29.7fdfe","9a52f5e5.0ed698"]]},{"id":"9a52f5e5.0ed698","type":"debug","z":"8ed43b88.623078","name":"","active":true,"console":"false","complete":"false","x":792,"y":941.7221956253052,"wires":[]},{"id":"89630462.1fa058","type":"debug","z":"8ed43b88.623078","name":"","active":true,"console":"false","complete":"true","x":537,"y":803.7221956253052,"wires":[]},{"id":"dcf4bdba.3b968","type":"http in","z":"8ed43b88.623078","name":"","url":"/patientData","method":"get","swaggerDoc":"","x":131,"y":957.7221956253052,"wires":[["23c82a86.add576"]]},{"id":"a3a815c6.d342e8","type":"http response","z":"8ed43b88.623078","name":"","x":578,"y":996.7221956253052,"wires":[]},{"id":"23c82a86.add576","type":"function","z":"8ed43b88.623078","name":"","func":"var patientName = msg.payload.patientName;\n\nif(context.global.patients[patientName] != null) {\n    msg.payload = context.global.patients[patientName];\n} else {\n    msg.res.send(\"404\", {\"errorMessage\" : \"Not found!\"});\n};\n\nmsg.headers = {\n    \"Access-Control-Allow-Origin\": \"*\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":345,"y":979.7221956253052,"wires":[["a3a815c6.d342e8"]]},{"id":"e7b8da0c.42c428","type":"debug","z":"8ed43b88.623078","name":"","active":true,"console":"true","complete":"payload.id","x":350.83331298828125,"y":589.8334274291992,"wires":[]},{"id":"a24908c.c3bbaf8","type":"http in","z":"8ed43b88.623078","name":"","url":"/oauth2callback","method":"get","x":145,"y":1195,"wires":[["ec2e4a3c.8a5488","435b8bd1.62e964"]]},{"id":"2b49c802.40b768","type":"http in","z":"8ed43b88.623078","name":"","url":"/auth","method":"get","x":110.17449378967285,"y":1152.68887424469,"wires":[["690137e0.45be58"]]},{"id":"690137e0.45be58","type":"function","z":"8ed43b88.623078","name":"Authenticate","func":"var ctx = context.global;\nOAuth2 = ctx.googleapis.OAuth2Client;\nvar oauthCallbackPath = ctx.url + \"/oauth2callback\";\nvar oauth2Client = new OAuth2(ctx.CLIENT_ID, ctx.CLIENT_SECRET, oauthCallbackPath);\n\n// generates a url that allows offline access and asks permissions\n// for Mirror API scope.\nvar url = oauth2Client.generateAuthUrl({\n  access_type: 'offline',\n  scope: 'https://www.googleapis.com/auth/glass.timeline https://www.googleapis.com/auth/glass.location https://www.googleapis.com/auth/plus.me'\n});\n\nmsg.res.redirect(url);","outputs":1,"x":280.88892364501953,"y":1153.117444038391,"wires":[[]]},{"id":"435b8bd1.62e964","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"true","complete":"payload","x":636.7143402099609,"y":1195.974609375,"wires":[]},{"id":"ec2e4a3c.8a5488","type":"async","z":"8ed43b88.623078","name":"GrabUserIdAndCacheCredentials","async":"var ctx = context.global;\nvar success = function () { console.log('Grab Authentication Token success')}\nvar failure = function () { msg.res.send(\"401\", {\"errorMessage\" : \"Failure\"}); }\n\nOAuth2 = context.global.googleapis.OAuth2Client;\nvar oauthCallbackPath = context.global.url + \"/oauth2callback\";\nvar oauth2Client = new OAuth2(ctx.CLIENT_ID, ctx.CLIENT_SECRET, oauthCallbackPath);\n\nvar grabUserIdAndCacheCredentials = function(oauth2Client, successCallback) {\n    ctx.googleapis\n    .discover('plus', 'v1')\n    .execute(function(err, client) {\n\t\tif(!!err) { \n\t\t\tconsole.error(err);\n\t\t\tmsg.res.send(\"401\", {\"errorMessage\" : err}); \n\t\t\treturn;\n\t\t}\n\t\tclient\n\t\t    .plus.people.get({ userId: 'me' })\n\t\t    .withAuthClient(oauth2Client)\n\t\t    .execute(function(err, res) {\t\n\t\t    \tif(!!err) { \t\t\t\t\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tmsg.res.send(\"401\", {\"errorMessage\" : err}); \n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmsg.payload = res;\n\t\t\t\tcb(msg);\n\t\t\t\tsuccessCallback(res.id, res.displayName, oauth2Client);\t\t\t\n\t\t\t});\t\t\n    });   \n};\n\nvar grabToken = function (code, oauth2Client, errorCallback, successCallback) {\n    oauth2Client.getToken(code, function (err, tokens) {\n        if (!!err) {\n            errorCallback(err);\n        } else {\n            console.log('tokens', tokens);\n            oauth2Client.setCredentials(tokens);\n            grabUserIdAndCacheCredentials(oauth2Client, successCallback);\n        }\n    });\n};\n\ngrabToken(msg.req.query.code, oauth2Client, failure, function (userId, name, oauth2Client) {\n        msg.res.send(\"200\", \"User is authenticated with Google with userId/name: \" + userId + \"/\" + name);\n        if(!ctx.cachedOAuthClients) ctx.cachedOAuthClients = {};        \n        ctx.cachedOAuthClients[userId] = {client : oauth2Client, name : name};\n\t\tmsg.payload = userId;\n        console.log(msg.payload);\n        cb(msg);\n});","outputs":1,"x":404.42858123779297,"y":1195.2603063583374,"wires":[["435b8bd1.62e964"]]},{"id":"8f345460.d5fce8","type":"http in","z":"8ed43b88.623078","name":"","url":"/timeline/:id","method":"post","x":136.42857360839844,"y":1239.974588394165,"wires":[["4da6864d.f7d198","305eade5.2f29e2"]]},{"id":"b041504a.685e3","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"true","complete":"false","x":695.5714569091797,"y":1242.831732749939,"wires":[]},{"id":"4da6864d.f7d198","type":"async","z":"8ed43b88.623078","name":"Validate payload","async":"if(!msg.req.params.id) { \n\tmsg.res.send(\"401\", {\"errorMessage\" : \"No ID in request\"});\n}\nreturn msg;","outputs":1,"x":352.14286041259766,"y":1240.4031610488892,"wires":[["93ef1068.02745","305eade5.2f29e2"]]},{"id":"93ef1068.02745","type":"async","z":"8ed43b88.623078","name":"Push Card","async":"var pushCard = function (card, oauth2Client) {\n    context.global.googleapis\n        .discover('mirror', 'v1')\n        .execute(function (err, client) {\n        console.log(\"HELLLOE\");\n        console.log(client);\n        console.warn(client);\n            if (!!err) {\n                msg.res.send(\"500\", JSON.stringify(err));\n                msg.payload = JSON.stringify(err);\n                cb(msg);\n                return;\n            }  \n   \t\t    Card(client, oauth2Client, card);            \n        });\n};\n\nvar Card = function (client, oauth2Client, card) {\n    client\n        .mirror.timeline.insert(card)\n        .withAuthClient(oauth2Client)\n        .execute(function (err, data) {\n            if (!!err) {               \n                msg.res.send(\"500\", JSON.stringify(err));\n                msg.payload = JSON.stringify(err);\n                cb(msg);\n            } else {\n                msg.res.send(\"200\", {\"message\" : \"'Create and Insert Card to Glass Timeline success'\"});\n                msg.payload = \"Success\";\n                cb(msg);\n            }\n        });\n};\n// &polyline=;42.36254,-71.08726,42.36297,-71.09364,42.36579,-71.09208,42.3697,-71.102,42.37105,-71.10104,42.37067,-71.1001,42.36561,-71.10406,42.36838,-71.10878,42.36968,-71.10703\nvar card =   msg.payload;\n        \nvar oauthClient = context.global.cachedOAuthClients[msg.req.params.id].client;\npushCard(card, oauthClient);","outputs":1,"x":547.8571548461914,"y":1242.2602987289429,"wires":[["b041504a.685e3"]]},{"id":"305eade5.2f29e2","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"true","complete":"true","x":347.2857208251953,"y":1293.1174430847168,"wires":[]},{"id":"e36071a5.d2119","type":"http in","z":"8ed43b88.623078","name":"","url":"/location/:id","method":"get","x":131.5714340209961,"y":1346.5460214614868,"wires":[["b8c91957.c859d8"]]},{"id":"b8c91957.c859d8","type":"async","z":"8ed43b88.623078","name":"Validate payload","async":"if(!msg.req.params.id) { \n\tmsg.res.send(\"401\", {\"errorMessage\" : \"No ID in request\"});\n}\nreturn msg;","outputs":1,"x":352.2857093811035,"y":1347.9745931625366,"wires":[["e58fdae1.c83a08","6d693991.2fa918"]]},{"id":"6d693991.2fa918","type":"async","z":"8ed43b88.623078","name":"Get location","async":"var getLocation = function (oauth2Client) {\n    context.global.googleapis\n        .discover('mirror', 'v1')\n        .execute(function (err, client) {\n            if (!!err) {\n                msg.statusCode = 500;\n                msg.payload = JSON.stringify(err);\n                cb(msg);\n                return;\n            }  \n   \t\t    Location(client, oauth2Client);            \n        });\n};\n\nvar Location = function (client, oauth2Client) {\n    client\n        .mirror.locations.get({id:\"latest\"})\n        .withAuthClient(oauth2Client)\n        .execute(function (err, data) {\n            if (!!err) {               \n                msg.statusCode = 500;\n                msg.payload = JSON.stringify(err);\n                cb(msg);\n            } else {\n            \tmsg.statusCode = 200;\n                msg.payload = data;             \n                cb(msg);\n            }\n        });\n};\n        \nvar oauthClient = context.global.cachedOAuthClients[msg.req.params.id].client;\ngetLocation(oauthClient);","outputs":1,"x":553.4285888671875,"y":1350.4031686782837,"wires":[["c03a4481.5053e8","627641af.c3dfa"]]},{"id":"e58fdae1.c83a08","type":"debug","z":"8ed43b88.623078","name":"","active":true,"console":"true","complete":"true","x":533.0000152587891,"y":1298.4031591415405,"wires":[]},{"id":"c03a4481.5053e8","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":"true","complete":"false","x":704.571403503418,"y":1301.974591255188,"wires":[]},{"id":"ecea26c8.4b2d48","type":"inject","z":"8ed43b88.623078","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":129.1428680419922,"y":1453.5460176467896,"wires":[["6216a33b.b3c63c"]]},{"id":"e9c7823d.40078","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":false,"complete":false,"x":635.0000457763672,"y":1450.4031982421875,"wires":[]},{"id":"6216a33b.b3c63c","type":"async","z":"8ed43b88.623078","name":"Get authentiated Glass IDs","async":"var ctx = context.global;\n//var keys = _.keys(ctx.cachedOAuthClients);\nfor(client in ctx.cachedOAuthClients) {\n\tcb({payload : ctx.cachedOAuthClients[client].name});\n}\n//msg.payload = keys;\n///return msg;\n","outputs":1,"x":376.5714569091797,"y":1452.5460271835327,"wires":[["e9c7823d.40078"]]},{"id":"1c873b67.8c5a25","type":"http in","z":"8ed43b88.623078","name":"","url":"/getAuthorized","method":"get","x":141.28572845458984,"y":1400.1174173355103,"wires":[["5d034de4.4faea4"]]},{"id":"5d034de4.4faea4","type":"async","z":"8ed43b88.623078","name":"Get authentiated Glass IDs","async":"var ctx = context.global;\nmsg.payload = {};\nfor(id in ctx.cachedOAuthClients) {\n\tmsg.payload[id] = {name : ctx.cachedOAuthClients[id].name}\n}\nreturn msg;\n","outputs":1,"x":380.0000228881836,"y":1400.1174383163452,"wires":[["5558c3f1.1eb70c"]]},{"id":"5558c3f1.1eb70c","type":"http response","z":"8ed43b88.623078","name":"","x":574.1428546905518,"y":1399.8317022323608,"wires":[]},{"id":"e610274c.6c8868","type":"inject","z":"8ed43b88.623078","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":129.14287567138672,"y":1500.5460367202759,"wires":[["8c86f3c6.f405"]]},{"id":"8c86f3c6.f405","type":"async","z":"8ed43b88.623078","name":"Clear authenticated glasses","async":"var ctx = context.global;\nctx.cachedOAuthClients = {};","outputs":1,"x":376.1428756713867,"y":1499.9746007919312,"wires":[["de80dcba.c424c"]]},{"id":"de80dcba.c424c","type":"debug","z":"8ed43b88.623078","name":"","active":false,"console":false,"complete":false,"x":573.0000152587891,"y":1500.4031629562378,"wires":[]},{"id":"627641af.c3dfa","type":"http response","z":"8ed43b88.623078","name":"","x":719.1428184509277,"y":1351.2603092193604,"wires":[]},{"id":"e6312317.e4493","type":"debug","z":"8ed43b88.623078","name":"","active":true,"console":"false","complete":"false","x":626.8333129882812,"y":1131.3334045410156,"wires":[]}]
